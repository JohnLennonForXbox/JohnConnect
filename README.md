# JohnConnect

peer-to-peer coordinator and savedata server for games like John Lennon Clicker

## Design considerations

- JohnConnect is game-agonistic, it's mostly client-authoritative in how data is exchanged between users and saved to their accounts
- In the case of multiplayer, JohnConnect server does not run game logic, a peer in a party is assigned host and they do all game logic on their client (acting as the server)
    - Parties exchange keys to verify who data is coming from
    - Server is still the ultimate administrative authority of a party, can close connections and send all players a message using a server key but cannot act as a player

## Running server

Copy `.env.example` to `.env`:

```bash
cp .env.example .env
```

> [!CAUTION]
> Change `JWT_SIGNING_KEY` to something long and random! This is used to sign the session tokens generated by JohnConnect. If you have `openssl` installed on your system, you can use the command `openssl rand -hex 64` to generate a long, random string based on cryptographically secure RNG.

Edit `.env` to fit your setup, and then run the server.

```bash
node --env-file=.env main.js
```

Example of a `systemd` unit for JohnConnect using a user named `johnconnect` with their home in `/home/johnconnect`, with the server in their home directory:

```ini
[Unit]
Description=JohnConnect server
After=network.target

[Service]
Type=simple
Restart=on-failure
RestartSec=5
; These 4 directives are specific to your setup
WorkingDirectory=/home/johnconnect/
ExecStart=/usr/bin/node --env-file=/home/johnconnect/.env /home/johnconnect/src/johnconnect.js
User=johnconnect
BindPaths=/home/johnconnect/db.sqlite ; Security directive that makes the database r/w for this service
; If you don't want to run JohnConnect on a port <= 1024 (for example using a reverse proxy) you can delete these two directives
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
; These directives make it harder to use JohnConnect to compromise the rest of its host
LockPersonality=yes
NoNewPrivileges=yes
PrivateUsers=self
ProtectClock=yes
ProtectControlGroups=yes
ProtectHome=read-only
ProtectHostname=yes
ProtectKernelLogs=yes
ProtectKernelModules=yes
ProtectKernelTunables=yes
ProtectProc=invisible
ProtectSystem=strict
RemoveIPC=yes
RestrictAddressFamilies=AF_INET AF_INET6
RestrictNamespaces=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
SystemCallArchitectures=native
NoExecPaths=/
; If you're using another runtime or node is located somewhere else you can change this
ExecPaths=/usr/bin/node /usr/lib


[Install]
WantedBy=multi-user.target
```
